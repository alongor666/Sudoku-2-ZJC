<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>数独游戏</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0e0;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 1200px;
            margin: 20px auto;
            background-color: #fff;
            padding: 20px;
            display: flex;
            border: 1px solid #ccc;
            box-sizing: border-box;
        }
        .game-area {
            display: flex;
            width: 100%;
        }
        .sudoku-board {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            gap: 0;
            background-color: #000;
            padding: 5px;
            width: calc(75% - 20px);
            aspect-ratio: 1;
            box-sizing: border-box;
        }
        .cell {
            background-color: #fff;
            aspect-ratio: 1;
            position: relative;
            cursor: pointer;
            border: 1px solid #ccc;
            font-size: 32px;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .cell span {
            position: absolute;
            font-size: 32px;
            color: darkblue;
        }

        .cell .mini-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            width: 100%;
            height: 100%;
            padding: 2px;
            box-sizing: border-box;
            gap: 2px;
        }

        .cell .mini-grid div {
            display: flex;
            justify-content: center;
            align-items: center;
            aspect-ratio: 1;
            font-size: 18px;
            background-color: #f0f0f0; /* 浅灰色背景 */
            color: black; /* 黑色字 */
            border-radius: 3px;
            box-sizing: border-box;
        }

        .cell.fixed-cell {
            background-color: #e0e0e0;
            cursor: default;
            font-weight: bold;
            color: black;
        }
        .cell.user-input {
            color: darkblue;
        }
        /* 统一浅灰色边框 */
        .cell {
            border: 1px solid #ccc;
        }
        /* 加粗九宫格边界 */
        .cell:nth-child(9n+1) {
            border-left: 1px solid #ccc;
        }
        .cell:nth-child(-n+9) {
            border-top: 1px solid #ccc;
        }
        .cell:nth-child(9n) {
            border-right: 1px solid #ccc;
        }
        .cell:nth-child(n+73) {
            border-bottom: 2px solid #ccc;
        }
        /* 第3和第6行底部边框加粗 */
        .cell:nth-child(n+19):nth-child(-n+27),
        .cell:nth-child(n+46):nth-child(-n+54) {
            border-bottom: 2px solid #857979dc;
        }
        /* 第3和第6列右边框加粗 */
        .cell:nth-child(3n) {
            border-right: 2px solid #857979dc;
        }
        .controls-panel {
            width: 25%;
            padding-left: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            font-family: 'Arial', sans-serif;
            max-height: 90vh;
            overflow-y: auto;
        }
        .section {
            margin-bottom: 4px; /* 减小section之间的间距 */
            padding: 4px; /* 减小内边距 */
            background-color: #f9f9f9;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section-title {
            font-size: 16px; /* 稍微减小标题字体大小 */
            font-weight: bold;
            margin-bottom: 8px; /* 减小标题下方间距 */
            color: #333;
        }
        .control-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px; /* 稍微减小按钮之间的间距 */
            margin-bottom: 8px; /* 减小控制组之间的间距 */
        }
        .control-group button,
        .control-group select {
            flex: 1 0 calc(50% - 5px);
            padding: 10px;
            font-size: 14px;
            cursor: pointer;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            transition: background-color 0.3s, color 0.3s;
        }
        .control-group button:hover,
        .control-group select:hover {
            background-color: #f0f0f0;
        }
        .number-pad {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px; /* 增加数字按钮之间的间距 */
            margin-bottom: 15px;
        }
        .number-btn {
            position: relative;
            padding: 15px; /* 增加数字按钮内边距 */
            font-size: 20px; /* 增大数字按钮字体大小 */
            cursor: pointer;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .number-btn .remaining-count {
            position: absolute;
            bottom: 3px;
            right: 3px;
            font-size: 12px;
            color: red;
        }
        .number-btn:hover {
            background-color: #f0f0f0;
        }
        .disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #timer, #score {
            font-size: 16px; /* 增大计时器和分数字体大小 */
            margin-bottom: 10px;
        }
        /* 响应式设计 */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                align-items: center;
            }
            .game-area {
                flex-direction: column;
                align-items: center;
            }
            .sudoku-board {
                width: 100%;
            }
            .controls-panel {
                width: 100%;
                padding-left: 0;
            }
        }
        .highlight-same {
            background-color: #FFFFE0 !important; /* 浅黄色背景 */
        }

        .highlight-same span,
        .highlight-same .mini-grid div.highlight-same {
            color: blue !important;
            font-weight: bold !important;
        }

        .cell .mini-grid div.highlight-same {
            background-color: #FFFFE0 !important; /* 确保mini-grid中的高亮数字也有浅黄色背景 */
        }
        .excluded {
            color: #ccc !important;
            text-decoration: line-through;
        }

        #random {
            background-color: #00008B; /* 深蓝色背景 */
            color: #E6F3FF; /* 极浅蓝色字 */
            border: none;
        }

        #random:hover {
            background-color: #000066; /* 鼠标悬停时稍微深一点的蓝色 */
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="game-area">
            <div class="sudoku-board" id="board"></div>
            <div class="controls-panel">
                <div class="section" id="scoreTimerSection">
                    <div id="timer">时间：00:00</div>
                    <div id="score">分数：0</div>
                </div>
                
                <div class="section" id="modeToggleSection">
                    <div class="section-title">游戏模式</div>
                    <div class="control-group">
                        <button id="toggleMode">切换到编辑模式</button>
                    </div>
                </div>
                
                <div class="section" id="puzzleInputSection">
                    <div class="section-title">自助出题</div>
                    <div class="control-group">
                        <button id="clear" class="disabled">清空网格</button>
                        <button id="submit" class="disabled">提交谜题</button>
                    </div>
                </div>
                
                <div class="section" id="gameSelectionSection">
                    <div class="section-title">游戏选择</div>
                    <div class="control-group">
                        <select id="difficulty">
                            <option value="easy">简单</option>
                            <option value="medium">普通</option>
                            <option value="hard">中级</option>
                            <option value="expert">高级</option>
                            <option value="hell">地狱</option>
                        </select>
                        <button id="random">生成谜题</button>
                    </div>
                </div>
                
                <div class="section" id="numberInputSection">
                    <div class="section-title">数字输入</div>
                    <div class="number-pad" id="numberPad">
                        <button class="number-btn" data-number="1">1<span class="remaining-count"></span></button>
                        <button class="number-btn" data-number="2">2<span class="remaining-count"></span></button>
                        <button class="number-btn" data-number="3">3<span class="remaining-count"></span></button>
                        <button class="number-btn" data-number="4">4<span class="remaining-count"></span></button>
                        <button class="number-btn" data-number="5">5<span class="remaining-count"></span></button>
                        <button class="number-btn" data-number="6">6<span class="remaining-count"></span></button>
                        <button class="number-btn" data-number="7">7<span class="remaining-count"></span></button>
                        <button class="number-btn" data-number="8">8<span class="remaining-count"></span></button>
                        <button class="number-btn" data-number="9">9<span class="remaining-count"></span></button>
                        <button class="number-btn" data-number="X">X</button>
                    </div>
                    <div class="control-group">
                        <button id="undo">撤销</button>
                        <button id="exclude">排除</button>
                    </div>
                </div>
                
                <div class="section" id="solvingToolsSection">
                    <div class="section-title">解题工具</div>
                    <div class="control-group">
                        <button id="showPossible">显示可能数字</button>
                        <button id="highlightSame">显示相同数字</button>
                    </div>
                    <div class="control-group">
                        <button id="highlightRelated">显示相关网格</button>
                        <button id="checkErrors">检查错误</button>
                    </div>
                    <div class="control-group">
                        <select id="hintMethodSelect">
                            <option value="1">剑鱼法</option>
                            <option value="2">强迫链</option>
                            <option value="3">隐性链</option>
                            <option value="4">X-Wing</option>
                            <option value="5">Y-Wing</option>
                            <option value="6">XYZ-Wing</option>
                            <option value="7">矩形顶点删减法</option>
                            <option value="8">三链数</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        (function() {
            const board = document.getElementById('board');
            const numberPad = document.getElementById('numberPad');
            const clearButton = document.getElementById('clear');
            const submitButton = document.getElementById('submit');
            const randomButton = document.getElementById('random');
            const undoButton = document.getElementById('undo');
            const toggleModeButton = document.getElementById('toggleMode');
            const checkErrorsButton = document.getElementById('checkErrors');
            const showPossibleButton = document.getElementById('showPossible');
            const highlightRelatedButton = document.getElementById('highlightRelated');
            const highlightSameButton = document.getElementById('highlightSame');
            const difficultySelect = document.getElementById('difficulty');
            const timerElement = document.getElementById('timer');
            const scoreElement = document.getElementById('score');
            const hintMethodSelect = document.getElementById('hintMethodSelect');
            const excludeButton = document.getElementById('exclude');

            let puzzle = Array(9).fill().map(() => Array(9).fill(0));
            let selectedNumber = null;
            let history = [];
            let showPossibleNumbers = false;
            let highlightRelatedCells = false;
            let highlightSameNumbers = false;
            let isEditMode = false;
            let isExcludeMode = false;
            let excludedNumbers = Array(9).fill().map(() => Array(9).fill().map(() => new Set()));

            let timerInterval;
            let totalSeconds = 0;
            let score = 0;
            let mistakes = 0;

            function init() {
                createBoard();
                bindEvents();
                updateModeDisplay();
                updateControlsAvailability();
            }

            function createBoard() {
                board.innerHTML = '';
                for (let i = 0; i < 9; i++) {
                    for (let j = 0; j < 9; j++) {
                        const cell = document.createElement('div');
                        cell.className = 'cell';
                        cell.dataset.row = i;
                        cell.dataset.col = j;
                        cell.tabIndex = 0; // 支持键盘导航
                        cell.addEventListener('click', () => {
                            setCellValue(cell);
                            if (highlightRelatedCells) highlightRelated(cell);
                            if (highlightSameNumbers) highlightSame(cell);
                        });
                        cell.addEventListener('keydown', (e) => {
                            handleCellKeydown(e, cell);
                        });
                        const span = document.createElement('span');
                        cell.appendChild(span);
                        board.appendChild(cell);
                    }
                }
                updateCellDisplay();
            }

            function bindEvents() {
                excludeButton.addEventListener('click', toggleExcludeMode);

                numberPad.addEventListener('click', (e) => {
                    if (e.target.classList.contains('number-btn')) {
                        const selectedNum = e.target.dataset.number === 'X' ? 'X' : parseInt(e.target.dataset.number);
                        selectNumber(selectedNum);

                        if (highlightSameNumbers && selectedNum !== 'X') {
                            const tempCell = document.createElement('div');
                            const span = document.createElement('span');
                            span.textContent = selectedNum;
                            tempCell.appendChild(span);
                            highlightSame(tempCell);
                        } else {
                            clearHighlights('highlight-same');
                        }
                    }
                });

                clearButton.addEventListener('click', clear);
                undoButton.addEventListener('click', undo);
                submitButton.addEventListener('click', () => {
                    if (isEditMode) {
                        isEditMode = false;
                        lockFixedCells();
                        updateModeDisplay();
                        updateControlsAvailability();
                    } else {
                        alert('谜题已提交！（功能未实现）');
                    }
                });

                randomButton.addEventListener('click', generateRandomPuzzle);
                toggleModeButton.addEventListener('click', () => {
                    toggleMode();
                    updateControlsAvailability();
                });
                checkErrorsButton.addEventListener('click', checkForErrors);
                showPossibleButton.addEventListener('click', () => {
                    showPossibleNumbers = !showPossibleNumbers;
                    showPossibleButton.textContent = showPossibleNumbers ? '隐藏可能数字' : '显示可能数字';
                    updateCellDisplay();
                });
                highlightRelatedButton.addEventListener('click', () => {
                    highlightRelatedCells = !highlightRelatedCells;
                    highlightRelatedButton.textContent = highlightRelatedCells ? '隐藏相关网格' : '显示相关网格';
                    if (!highlightRelatedCells) clearHighlights('highlight-related');
                });
                highlightSameButton.addEventListener('click', () => {
                    highlightSameNumbers = !highlightSameNumbers;
                    highlightSameButton.textContent = highlightSameNumbers ? '隐藏相同数字' : '显示相同数字';
                    if (!highlightSameNumbers) clearHighlights('highlight-same');
                });
                hintMethodSelect.addEventListener('change', () => {
                    chooseHintMethod();
                });
            }

            function setCellValue(cell) {
                const row = parseInt(cell.dataset.row);
                const col = parseInt(cell.dataset.col);
                if (!isEditMode && cell.classList.contains('fixed-cell')) return;
                if (selectedNumber !== null) {
                    if (isExcludeMode) {
                        excludeNumber(row, col, selectedNumber);
                    } else {
                        const oldValue = puzzle[row][col];
                        puzzle[row][col] = selectedNumber === 'X' ? 0 : selectedNumber;
                        updateCellDisplay();
                        history.push({ row, col, oldValue, newValue: puzzle[row][col] });
                        if (isBoardFull()) {
                            if (validateBoard()) {
                                clearInterval(timerInterval);
                                alert('恭喜，你完成了数独！');
                            } else {
                                mistakes++;
                                updateScore();
                                alert('存在逻辑错误，请检查你的答案。');
                            }
                        }
                    }
                }
            }

            function handleCellKeydown(e, cell) {
                const key = e.key;
                if (key >= '1' && key <= '9') {
                    selectedNumber = parseInt(key);
                    setCellValue(cell);
                } else if (key === 'Backspace' || key === 'Delete' || key === '0') {
                    selectedNumber = 'X';
                    setCellValue(cell);
                } else if (key === 'ArrowUp') {
                    navigateCell(cell, -1, 0);
                } else if (key === 'ArrowDown') {
                    navigateCell(cell, 1, 0);
                } else if (key === 'ArrowLeft') {
                    navigateCell(cell, 0, -1);
                } else if (key === 'ArrowRight') {
                    navigateCell(cell, 0, 1);
                }
            }

            function navigateCell(cell, rowOffset, colOffset) {
                const row = parseInt(cell.dataset.row);
                const col = parseInt(cell.dataset.col);
                const newRow = (row + rowOffset + 9) % 9;
                const newCol = (col + colOffset + 9) % 9;
                const newCell = document.querySelector(`.cell[data-row='${newRow}'][data-col='${newCol}']`);
                if (newCell) {
                    newCell.focus();
                }
            }

            function selectNumber(num) {
                selectedNumber = num;
                const buttons = numberPad.getElementsByClassName('number-btn');
                for (let button of buttons) {
                    button.style.backgroundColor = button.dataset.number === num.toString() ? '#e0e0e0' : '';
                }
            }

            function updateCellDisplay() {
                const cells = board.getElementsByClassName('cell');
                for (let cell of cells) {
                    const row = parseInt(cell.dataset.row);
                    const col = parseInt(cell.dataset.col);
                    const span = cell.querySelector('span');
                    cell.classList.remove('fixed-cell', 'error-cell', 'highlight-related', 'highlight-same', 'user-input');
                    span.textContent = '';
                    span.innerHTML = '';

                    if (puzzle[row][col] !== 0) {
                        span.textContent = puzzle[row][col];
                        if (cell.classList.contains('fixed-cell')) {
                            span.style.color = 'black';
                        } else {
                            span.style.color = 'darkblue';
                            cell.classList.add('user-input');
                        }
                    } else if (showPossibleNumbers) {
                        const possibleNumbers = getPossibleNumbers(row, col);
                        const miniGrid = document.createElement('div');
                        miniGrid.className = 'mini-grid';
                        for (let i = 0; i < 9; i++) {
                            const miniCell = document.createElement('div');
                            const num = i + 1;
                            if (possibleNumbers.includes(num)) {
                                miniCell.textContent = num;
                                if (excludedNumbers[row][col].has(num)) {
                                    miniCell.classList.add('excluded');
                                }
                            }
                            miniGrid.appendChild(miniCell);
                        }
                        span.appendChild(miniGrid);
                    }
                }
                updateNumberPad();
            }

            function getPossibleNumbers(row, col) {
                if (puzzle[row][col] !== 0) return [];
                const possible = [];
                for (let num = 1; num <= 9; num++) {
                    if (isValid(puzzle, row, col, num) && !excludedNumbers[row][col].has(num)) {
                        possible.push(num);
                    }
                }
                return possible;
            }

            function toggleMode() {
                isEditMode = !isEditMode;
                updateModeDisplay();
                if (!isEditMode) {
                    lockFixedCells();
                } else {
                    unlockCells();
                }
                updateControlsAvailability();
            }

            function updateModeDisplay() {
                toggleModeButton.textContent = isEditMode ? '切换到游戏模式' : '切换到编辑模式';
            }

            function lockFixedCells() {
                const cells = board.getElementsByClassName('cell');
                for (let cell of cells) {
                    const row = parseInt(cell.dataset.row);
                    const col = parseInt(cell.dataset.col);
                    if (puzzle[row][col] !== 0) {
                        cell.classList.add('fixed-cell');
                    }
                }
            }

            function unlockCells() {
                const cells = board.getElementsByClassName('cell');
                for (let cell of cells) {
                    cell.classList.remove('fixed-cell');
                }
            }

            function clear() {
                puzzle = Array(9).fill().map(() => Array(9).fill(0));
                excludedNumbers = Array(9).fill().map(() => Array(9).fill().map(() => new Set()));
                updateCellDisplay();
                history = [];
                if (!isEditMode) unlockCells();
                clearInterval(timerInterval);
                totalSeconds = 0;
                updateTimerDisplay();
                score = 0;
                updateScore();
            }

            function undo() {
                if (history.length > 0) {
                    const lastAction = history.pop();
                    puzzle[lastAction.row][lastAction.col] = lastAction.oldValue;
                    updateCellDisplay();
                }
            }

            function generateRandomPuzzle() {
                const difficulty = difficultySelect.value;
                puzzle = generateUniqueSolutionPuzzle(difficulty);
                updateCellDisplay();
                lockFixedCells();
                history = [];
                startTimer();
                mistakes = 0;
                updateScore();
            }

            function generateUniqueSolutionPuzzle(difficulty) {
                let board = Array(9).fill().map(() => Array(9).fill(0));
                generateSolution(board);
                let cellsToRemove;
                switch (difficulty) {
                    case 'easy': cellsToRemove = 35; break;
                    case 'medium': cellsToRemove = 40; break;
                    case 'hard': cellsToRemove = 45; break;
                    case 'expert': cellsToRemove = 50; break;
                    case 'hell': cellsToRemove = 55; break;
                    default: cellsToRemove = 45;
                }

                let cells = shuffle([...Array(81).keys()]);
                for (let i = 0; i < cells.length && cellsToRemove > 0; i++) {
                    let row = Math.floor(cells[i] / 9);
                    let col = cells[i] % 9;
                    let temp = board[row][col];
                    board[row][col] = 0;
                    let copy = board.map(row => [...row]);
                    if (!isUnique(copy)) {
                        board[row][col] = temp;
                    } else {
                        cellsToRemove--;
                    }
                }
                return board;
            }

            function isUnique(board) {
                return countSolutions(board) === 1;
            }

            function countSolutions(board) {
                let solutions = 0;
                solveSudoku(board, 0, 0);

                function solveSudoku(board, row, col) {
                    if (row === 9) {
                        solutions++;
                        return;
                    }
                    if (col === 9) {
                        solveSudoku(board, row + 1, 0);
                        return;
                    }
                    if (board[row][col] !== 0) {
                        solveSudoku(board, row, col + 1);
                        return;
                    }
                    for (let num = 1; num <= 9 && solutions < 2; num++) {
                        if (isValid(board, row, col, num)) {
                            board[row][col] = num;
                            solveSudoku(board, row, col + 1);
                            board[row][col] = 0;
                        }
                    }
                }
                return solutions;
            }

            function generateSolution(board) {
                let nums = [1, 2, 3, 4, 5, 6, 7, 8, 9];
                return fillBoard(board, 0, 0);

                function fillBoard(board, row, col) {
                    if (col === 9) {
                        row++;
                        col = 0;
                    }
                    if (row === 9) {
                        return true;
                    }
                    if (board[row][col] !== 0) {
                        return fillBoard(board, row, col + 1);
                    }
                    nums = shuffle(nums);
                    for (let num of nums) {
                        if (isValid(board, row, col, num)) {
                            board[row][col] = num;
                            if (fillBoard(board, row, col + 1)) {
                                return true;
                            }
                            board[row][col] = 0;
                        }
                    }
                    return false;
                }
            }

            function isValid(board, row, col, num) {
                for (let x = 0; x < 9; x++) {
                    if (board[row][x] === num || board[x][col] === num) {
                        return false;
                    }
                }
                let startRow = Math.floor(row / 3) * 3;
                let startCol = Math.floor(col / 3) * 3;
                for (let i = 0; i < 3; i++) {
                    for (let j = 0; j < 3; j++) {
                        if (board[startRow + i][startCol + j] === num) {
                            return false;
                        }
                    }
                }
                return true;
            }

            function shuffle(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    let j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            function isBoardFull() {
                for (let row of puzzle) {
                    if (row.includes(0)) return false;
                }
                return true;
            }

            function validateBoard() {
                for (let i = 0; i < 9; i++) {
                    if (!validateArray(puzzle[i])) return false;
                    const column = puzzle.map(row => row[i]);
                    if (!validateArray(column)) return false;
                }
                for (let boxRow = 0; boxRow < 3; boxRow++) {
                    for (let boxCol = 0; boxCol < 3; boxCol++) {
                        const box = [];
                        for (let i = 0; i < 3; i++) {
                            for (let j = 0; j < 3; j++) {
                                box.push(puzzle[boxRow * 3 + i][boxCol * 3 + j]);
                            }
                        }
                        if (!validateArray(box)) return false;
                    }
                }
                return true;
            }

            function validateArray(arr) {
                const nums = arr.filter(num => num !== 0);
                return nums.length === new Set(nums).size;
            }

            function checkForErrors() {
                clearHighlights('error-cell');
                let hasError = false;
                for (let i = 0; i < 9; i++) {
                    const row = puzzle[i];
                    const col = puzzle.map(row => row[i]);
                    if (!highlightErrors(row, i, 'row')) hasError = true;
                    if (!highlightErrors(col, i, 'col')) hasError = true;
                }
                for (let boxRow = 0; boxRow < 3; boxRow++) {
                    for (let boxCol = 0; boxCol < 3; boxCol++) {
                        const box = [];
                        for (let i = 0; i < 3; i++) {
                            for (let j = 0; j < 3; j++) {
                                box.push({
                                    value: puzzle[boxRow * 3 + i][boxCol * 3 + j],
                                    row: boxRow * 3 + i,
                                    col: boxCol * 3 + j
                                });
                            }
                        }
                        if (!highlightErrors(box.map(cell => cell.value), box, 'box')) hasError = true;
                    }
                }
                if (hasError) {
                    mistakes++;
                    updateScore();
                    alert('数独中存在错误，请检查红色高亮单元格。');
                } else {
                    alert('未发现错误！');
                }
            }

            function highlightErrors(arr, index, type) {
                const nums = {};
                let isValid = true;
                arr.forEach((num, idx) => {
                    if (num !== 0) {
                        if (nums[num]) {
                            isValid = false;
                            if (type === 'row') {
                                highlightErrorCell(index, idx);
                                highlightErrorCell(index, nums[num].index);
                            } else if (type === 'col') {
                                highlightErrorCell(idx, index);
                                highlightErrorCell(nums[num].index, index);
                            } else if (type === 'box') {
                                highlightErrorCell(arr[idx].row, arr[idx].col);
                                highlightErrorCell(nums[num].row, nums[num].col);
                            }
                        } else {
                            nums[num] = { index: idx, row: arr[idx].row, col: arr[idx].col };
                        }
                    }
                });
                return isValid;
            }

            function highlightErrorCell(row, col) {
                const cell = document.querySelector(`.cell[data-row='${row}'][data-col='${col}']`);
                if (cell) cell.classList.add('error-cell');
            }

            function highlightRelated(cell) {
                clearHighlights('highlight-related');
                const row = parseInt(cell.dataset.row);
                const col = parseInt(cell.dataset.col);
                const cells = board.getElementsByClassName('cell');
                for (let c of cells) {
                    const cellRow = parseInt(c.dataset.row);
                    const cellCol = parseInt(c.dataset.col);
                    if (cellRow === row || cellCol === col ||
                        (Math.floor(cellRow / 3) === Math.floor(row / 3) &&
                            Math.floor(cellCol / 3) === Math.floor(col / 3))) {
                        c.classList.add('highlight-related');
                    }
                }
            }

            function highlightSame(cell) {
                clearHighlights('highlight-same');
                let value;
                if (cell.tagName === 'BUTTON') {
                    value = cell.dataset.number;
                } else {
                    value = cell.querySelector('span').textContent;
                }

                if (value && value !== 'X') {
                    const cells = board.getElementsByClassName('cell');
                    for (let c of cells) {
                        const span = c.querySelector('span');
                        if (span.textContent === value) {
                            c.classList.add('highlight-same');
                            span.classList.add('highlight-same');
                        }
                        const miniGrid = c.querySelector('.mini-grid');
                        if (miniGrid) {
                            const miniCells = miniGrid.querySelectorAll('div');
                            miniCells.forEach(miniCell => {
                                if (miniCell.textContent === value) {
                                    miniCell.classList.add('highlight-same');
                                    c.classList.add('highlight-same'); // 添加这行以高亮整个单元格
                                }
                            });
                        }
                    }
                }
            }

            function clearHighlights(className) {
                const cells = board.getElementsByClassName('cell');
                for (let cell of cells) {
                    cell.classList.remove(className);
                    const miniGrid = cell.querySelector('.mini-grid');
                    if (miniGrid) {
                        const miniCells = miniGrid.querySelectorAll('div');
                        miniCells.forEach(miniCell => {
                            miniCell.classList.remove(className);
                        });
                    }
                }
            }

            function updateNumberPad() {
                const counts = Array(10).fill(9);
                for (let row = 0; row < 9; row++) {
                    for (let col = 0; col < 9; col++) {
                        let num = puzzle[row][col];
                        if (num !== 0) {
                            counts[num]--;
                        }
                    }
                }
                const numberButtons = document.querySelectorAll('.number-btn');
                let allCompleted = true;
                numberButtons.forEach(button => {
                    let num = button.dataset.number;
                    if (num !== 'X') {
                        let countSpan = button.querySelector('.remaining-count');
                        countSpan.textContent = counts[num];
                        if (counts[num] === 0) {
                            button.disabled = true;
                        } else {
                            button.disabled = false;
                            allCompleted = false;
                        }
                    }
                });

                // 如果当前选中的数字已完成,自动选择下一个未完成的数字
                if (selectedNumber !== null && selectedNumber !== 'X' && counts[selectedNumber] === 0) {
                    let nextNumber = findNextIncompleteNumber(selectedNumber);
                    if (nextNumber !== null) {
                        selectNumber(nextNumber);
                    }
                }
            }

            function findNextIncompleteNumber(currentNumber) {
                const counts = Array(10).fill(9);
                for (let row = 0; row < 9; row++) {
                    for (let col = 0; col < 9; col++) {
                        let num = puzzle[row][col];
                        if (num !== 0) {
                            counts[num]--;
                        }
                    }
                }

                // 从当前数字开始,向两个方向查找最近的未完成数字
                for (let i = 1; i <= 9; i++) {
                    let nextNum = (currentNumber + i - 1) % 9 + 1;
                    let prevNum = (currentNumber - i + 8) % 9 + 1;
                    if (counts[nextNum] > 0) return nextNum;
                    if (counts[prevNum] > 0) return prevNum;
                }

                return null; // 如果所有数字都已完成
            }

            function startTimer() {
                clearInterval(timerInterval);
                totalSeconds = 0;
                updateTimerDisplay();
                timerInterval = setInterval(updateTimer, 1000);
            }

            function updateTimer() {
                totalSeconds++;
                updateTimerDisplay();
                updateScore();
            }

            function updateTimerDisplay() {
                let minutes = Math.floor(totalSeconds / 60);
                let seconds = totalSeconds % 60;
                timerElement.textContent = `时间：${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }

            function updateScore() {
                score = Math.max(0, 10000 - (totalSeconds * 10) - (mistakes * 100));
                scoreElement.textContent = `分数：${score}`;
            }

            function updateControlsAvailability() {
                const puzzleInputButtons = document.querySelectorAll('#puzzleInputSection button');
                const gameSelectionControls = document.querySelectorAll('#gameSelectionSection select, #gameSelectionSection button');

                if (isEditMode) {
                    puzzleInputButtons.forEach(btn => btn.classList.remove('disabled'));
                    gameSelectionControls.forEach(ctrl => ctrl.classList.add('disabled'));
                } else {
                    puzzleInputButtons.forEach(btn => btn.classList.add('disabled'));
                    gameSelectionControls.forEach(ctrl => ctrl.classList.remove('disabled'));
                }
            }

            function chooseHintMethod() {
                const method = hintMethodSelect.value;
                switch (method) {
                    case '1':
                        applySwordfishMethod();
                        break;
                    case '2':
                        applyForcedChainMethod();
                        break;
                    // 添加其他解题方法的处理
                    default:
                        alert('该解题方法尚未实现。');
                }
            }

            function applySwordfishMethod() {
                alert('剑鱼法功能尚未实现。');
            }

            function applyForcedChainMethod() {
                alert('强迫链功能尚未实现。');
            }

            function excludeNumber(row, col, num) {
                if (num === 'X') return;
                if (excludedNumbers[row][col].has(num)) {
                    excludedNumbers[row][col].delete(num);
                } else {
                    excludedNumbers[row][col].add(num);
                }
                updateCellDisplay();
            }

            function toggleExcludeMode() {
                isExcludeMode = !isExcludeMode;
                const excludeButton = document.getElementById('exclude');
                excludeButton.textContent = isExcludeMode ? '取消排除' : '排除';
                excludeButton.style.backgroundColor = isExcludeMode ? '#e0e0e0' : '';
            }

            // 其他解题方法函数...

            init();
        })();
    </script>
</body>
</html>